#!/usr/bin/env python3

import itertools
import json

# Creates an image-mapping.json file from a message dump file

msgs_file = 'messages.txt'
delimiter = '<delimiter>'

def main():
    with open(msgs_file, "r") as f:
        msgs = f.read()
        msg_list = msgs.split(delimiter)
    mapping = build_msg_index(msg_list)
    with open('image-mapping.json', 'w') as f:
        json.dump(mapping, f)

def build_msg_index(msg_list):
    label_mapping = translation_dict()
    msg_index = {}

    def find_matches(msg_i, words, key, labels):
        for w in words:
            for l in labels:
                if w.startswith(l):
                    if key not in msg_index:
                        msg_index[key] = []
                    msg_index[key].append(msg_i)
                    return

    for msg_i, msg in enumerate(msg_list):
        if msg_i % 1000 == 0:
            print(f'Indexing message #{msg_i} out of {len(msg_list)}')
        for key, labels in label_mapping.items():
            find_matches(msg_i, msg.split(' '), key, labels)

    return msg_index

def translation_dict():
    with open('label-dict.json', 'r') as f:
        label_dict = json.load(f)
    return {k: expand_label(v.lower()) for k, v in label_dict.items()}

dogs = [
        'Чихуахуа', 'Японский спаниель', 'Мальтийская собака', 'пекинес', 'Ши-тцу', 'Бленхейм спаниель', 'папиллон', 'той терьер', 'Родезийский риджбек', 'Афганская борзая', 'бассет', 'гончая', 'ищейка', 'Bluetick', 'черно-подпалый кунхаунд', 'Уокер гончая', 'Английская лиса', 'Redbone', 'борзая', 'Ирландский волкодав', 'Итальянская борзая', 'гончая', 'Ибанская борзая', 'Норвежский эльхунд', 'Otterhound', 'салуки', 'Шотландский олень', 'Веймаранер', 'Стаффордширский бультерьер', 'Американский стаффордширский терьер', 'Бедлингтон терьер', 'Пограничный терьер', 'Керри блю терьер', 'Ирландский терьер', 'Норфолк терьер', 'Норвич терьер', 'йоркширский терьер', 'жесткошерстный фокстерьер', 'Лейкленд терьер', 'Силихем терьер', 'эрдельтерьер', 'гурий', 'Австралийский терьер', 'Денди Динмонт', 'Бостонский бык', 'цвергшнауцер', 'ризеншнауцер', 'стандартный шнауцер', 'Скотч терьер', 'Тибетский терьер', 'шелковистый терьер', 'мягкошерстный пшеничный терьер', 'Вест хайленд уайт терьер', 'Лхаса', 'ретривер с плоским покрытием', 'курчавый ретривер', 'золотистый ретривер', 'Лабрадор ретривер', 'Чесапик Бэй ретривер', 'Немецкая короткошерстная указка', 'Vizsla', 'Английский сеттер', 'Ирландский сеттер', 'Гордон сеттер', 'Британи спаниель', 'Clumber', 'Английский спрингер', 'Валлийский спрингер спаниель', 'кокер-спаниель', 'Сассекс спаниель', 'Ирландский водный спаниель', 'кувас', 'шипперке', 'Groenendael', 'малинуа', 'бриар', 'злой водяной', 'Комондор', 'Древнеанглийская овчарка', 'Шетландские овчарки', 'колли', 'Бордер колли', 'Bouvier des Flandres', 'ротвейлер', 'немецкая овчарка', 'доберман', 'миниатюрный пинчер', 'Большая швейцарская горная собака', 'Бернский зенненхунд', 'аппенцелльский', 'Entlebucher', 'боксер', 'бычий дог', 'тибетский мастиф', 'французский бульдог', 'Немецкий дог', 'Сенбернар', 'Эскимос', 'маламут', 'Сибирский хаски', 'далматинец', 'Affenpinscher', 'басенджи', 'мопс', 'Леонберга', 'Ньюфаундленд', 'Великие Пиренеи', 'самоед', 'шпиц', 'чау', 'Keeshond', 'Брабансон гриффон', 'Пембрук', 'Кардиган', 'Игрушечный пудель', 'миниатюрный пудель', 'стандартный пудель'
]

phrase_substitutions = {
    'экран окна': ['жалюз'],
    'французский хлеб': ['батон', 'булк'],
    'бабушка смит': ['яблок', 'яблоч'],
    'фотокопировальное устройство': ['копирк', 'печат'],
    'карманный компьютер': ['смартфон', 'телефон'],
    'портативный компьютер': ['ноут', 'комп'],
    'СиДи плэйер': ['плеер', 'музык'],
    'блуждающий огонек': ['halloween', 'хэллоуин', 'тыкв'],
    'египетский кот': ['кот', 'кошк'],
    'мадагаскарская кошка': ['кот', 'кошк'],
    'сиамская кошка': ['кот', 'кошк'],
    'сиамская кошка': ['кот', 'кошк'],
    'персидский кот': ['кот', 'кошк'],
    **{d: ['собак', 'пес', 'псин', 'догго'] for d in dogs}
}

word_substitutions = {
    'веб-сайт': ['веб', 'сайт'],
    'телевидение': ['теле'],
    'фуфайка': ['кофт', 'джемп'],
    'клубника': ['клубник'],
    'гранатовый': ['гранат'],
    'пластина': ['тарелк', 'блюд', 'еда', 'кушат'],
    'чизбургер': ['бургер', 'макд'],
    'школьный': ['школ'],
    'тедди': ['плюш', 'мишк'],
    'петух': ['петух', 'петуш'],
    'hammerhead': ['акул', 'рыб'],
    'конвертируемый': ['кабриолет', 'машин', 'авто', 'дорога'],
    'электрогитара': ['гитара', 'рок', 'метал'],
    'hoopskirt': ['плать'],
    'overskirt': ['плать'],
    'ipod': ['яблоко', 'ipod', 'apple', 'джобс'],
    'почтовый': ['почт'],
    'легче': ['зажигалка'],
    'футеровка': ['корабл'],
    'объектива': ['фото', 'объектив', 'зеркалк'],
    'jinrikisha': ['карет'],
    'люка': ['люк', 'водопровод', 'канализ'],
    'комикс': ['аниме', 'манга'],
    'динго': ['додж', 'доге', 'doge']
}

def expand_label(label):
    if label in phrase_substitutions:
        return phrase_substitutions[label]

    if ' ' in label:
        return list(itertools.chain.from_iterable(
            expand_label(l) for l in label.split(' ')
            if l != 'на' and l != 'для' and l != 'от' and l != 'с' and l != 'в'
        ))

    if label in word_substitutions:
        return word_substitutions[label]

    if label.endswith('ы'):
        return [label[:-1]]
    if label.endswith('ок'):
        return [label[:-2]]
    if label.endswith('нский') or label.endswith('нская'):
        return [label[:-5]]
    if label.endswith('ский') or label.endswith('ская') or label.endswith('ское') or label.endswith('ские'):
        return [label[:-4]]
    if label.endswith('ный') or label.endswith('ная') or label.endswith('ное') or label.endswith('ные'):
        return [label[:-3]]
    if label.endswith('ая'):
        return [label[:-2]]

    return [label]

main()
